<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Endereços</title>
  <link rel="stylesheet" href="css/padronizacao.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="shortcut icon" href="assets/home/logo.svg" type="image/x-icon">
  <link rel="stylesheet" href="css/gerenciar_endereco.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>

  <header>
    <div class="header-container">
      <img src="assets/home/logo.svg" alt="">
    </div>
  </header>


  <div class="container-principal">
    <div class="cabecalho-esquerdo">
      <div class="opcoes-cabecalho">
        <div class="foto-usuario">
          <img src="assets/gerenciador/User.svg" alt="">
          <p id="user">Eleva User</p>
        </div>

        <div class="icone" id="dash" onclick="irParaDashboard()">
          <img src="assets/cruds/dashboard.svg" alt="">


          <p>Dashboard</p>
        </div>

        <div class="icone" id="enderecos" onclick="irParaEnderecos()">
          <img src="assets/cruds/enderecos.svg" alt="">
          <p>Endereços</p>
        </div>

        <div class="icone" id="gerenciar" onclick="irParaGerenciar()">
          <img src="assets/cruds/gerenciar.svg" alt="">
          <p>Gerenciar</p>
        </div>

        <div class="icone" id="conta" onclick="irParaConta()">
          <img src="assets/cruds/conta.svg" alt="">
          <p>Conta</p>
        </div>
        <div class="icone" id="solicitacao" onclick="irParaSolicitacao()">
          <img src="assets/cruds/solicitacoes.svg" alt="">
          <p>Solicitações</p>
        </div>
      </div>

      <div class="icone-saida" onclick="sair()">
        <img src="assets/gerenciador/sair.svg" alt="">
      </div>
    </div>

    <div class="gerenciador">

      <div class="titulo">
        <p>Gerenciar Endereços</p>
      </div>

      <div class="buttons">

        <button onclick="removerEndereco()" id="endereco-button">
          Remover <i class="bi bi-dash-circle" id="icons-button"></i>
        </button>

        <button onclick="adicionarEndereco()" id="endereco-button">
          Adicionar <i class="bi bi-plus-circle" id="icons-button"></i>
        </button>

        <button onclick="editarEndereco()" id="endereco-button">
          Editar <i class="bi bi-pencil" id="icons-button"></i>
        </button>

      </div>

      </main>


      <table id="tabelaUsuarios">
        <thead>
          <tr>
            <th id="id-column">ID</th>
            <th>CEP</th>
            <th>Endereço</th>
            <th>Gerente</th>
            <th id="id-cadastro">Nome da Loja</th>
            <th class="col-acoes" style="display: none;">Ação</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>




      <script>

        user.innerHTML = sessionStorage.getItem("NOME");

        async function CriarTabela() {
          const email = sessionStorage.getItem('emailUsuario')
          console.log(email)
          console.log("Entrei na função Criar Tabela");

          try {
            // Passa o email na query string para a rota
            const resposta = await fetch(`/gerenciamento/listarEnderecos?email=${encodeURIComponent(email)}`);
            const enderecos = await resposta.json();

            const tabela = document.getElementById("tabelaUsuarios").getElementsByTagName("tbody")[0];
            tabela.innerHTML = ""; // Limpa antes de preencher

            enderecos.forEach(endereco => {
              const linha = tabela.insertRow();

              linha.insertCell(0).textContent = endereco.idendereco;
              linha.insertCell(1).textContent = endereco.cep;

              const enderecoCompleto = `${endereco.logradouro}, ${endereco.numero} - ${endereco.bairro}, ${endereco.cidade}`;
              linha.insertCell(2).textContent = enderecoCompleto;

              linha.insertCell(3).textContent = `${endereco.email} (${endereco.cargo})`;

              linha.insertCell(4).textContent = endereco.nome_fantasia ?? "Sem cadastro";


              const celulaAcoes = linha.insertCell(5);
              celulaAcoes.classList.add("col-acoes");
              celulaAcoes.style.display = "none";
              celulaAcoes.innerHTML = `<i class="bi bi-trash" style="color:red; cursor:pointer; font-size: 30px;" onclick="removerLinha(this)"></i>`;
            });



          } catch (erro) {
            console.error("Erro ao buscar dados:", erro);
          }
        }
        window.onload = CriarTabela;


        let modoRemoverAtivo = false;

        function removerEndereco() {
          const colunasAcoes = document.querySelectorAll(".col-acoes");
          modoRemoverAtivo = !modoRemoverAtivo;

          colunasAcoes.forEach(col => {
            col.style.display = modoRemoverAtivo ? "table-cell" : "none";
          });
        }

        async function removerLinha(iconElement) {
          // Pega a linha (tr) que contém o ícone clicado
          const linha = iconElement.closest('tr');

          // Pega o ID do endereço na primeira célula da linha
          const idEndereco = linha.cells[0].textContent;

          // Confirma se o usuário quer mesmo remover
          const confirma = confirm(`Deseja realmente remover o endereço ID ${idEndereco}?`);
          if (!confirma) return;

          try {
            // Faz requisição DELETE para a API do backend
            const resposta = await fetch(`/gerenciamento/removerEndereco/${idEndereco}`, {
              method: 'DELETE'
            });

            if (resposta.ok) {
              // Remove a linha da tabela se deu certo
              linha.remove();


              Swal.fire({
                title: "Endereço removido com sucesso!",
                icon: "success",
                draggable: true
              });


            } else {
              // Caso dê erro, mostra mensagem

              Swal.fire({
                icon: "error",
                title: "Erro",
                text: "Erro ao remover endereço.",

              });
              console.error('Erro na resposta do servidor:', resposta.statusText);
            }
          } catch (erro) {

            Swal.fire({
              icon: "error",
              title: "Erro",
              text: "Erro na comunicação com o servidor.",

            });
            console.error(erro);
          }
        }


      </script>