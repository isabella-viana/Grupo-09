<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Cadastro de Empresas | ELEVA</title>
    <link rel="stylesheet" href="css/solicitacao.css">
    <link rel="shortcut icon" href="assets/home/logo.svg" type="image/x-icon">
</head>

<body>
    <div class="container">
        <div class="solicitacoes">
            <h2>Solicitações</h2>
            <table>
                <thead>
                    <tr>
                        <th>Razão social</th>
                        <th>Nome empresa</th>
                        <th>Email contato</th>
                        <th>CNPJ</th>
                    </tr>
                </thead>
                <tbody id="tabela_empresas">
                </tbody>
            </table>
        </div>

        <div class="formulario">
            <h2>ELEVA</h2>
            <form onsubmit="return false;">
                <div class="campo">
                    <p>Razão Social</p>
                    <input type="text" id="input_razao_social" placeholder="">
                </div>

                <div class="campo">
                    <p>Nome Fantasia</p>
                    <input type="text" id="input_nome_fantasia" placeholder="">
                </div>

                 <div class="campo">
                    <p>CNPJ</p>
                    <input type="text" id="input_cnpj" placeholder="">
                </div>

                 <div class="campo">
                    <p>Nome Representante</p>
                    <input type="text" id="input_nome_representante" placeholder="">
                </div>

                <div class="campo">
                    <p>Email Representante</p>
                    <input type="email" id="input_email_representante" placeholder="">
                </div>

                 <div class="campo">
                    <p>CPF</p>
                    <input type="text" id="input_cpf" placeholder="">
                </div>
            
                <button type="submit" onclick="cadastrarEmpresa()">Registrar</button>
            </form>

            <div class="home-icon">
                <img src="assets/cruds/home.svg" alt="Home" />
            </div>
        </div>
    </div>

    <script>
        function cadastrarEmpresa() {
            
            var razaoSocialVar = input_razao_social.value;
            var nomeFantasiaVar = input_nome_fantasia.value;
            var cnpjVar = input_cnpj.value;

            if (!razaoSocialVar || !nomeFantasiaVar || !cnpjVar) {
                alert('Preencha todos os campos!');
                return false;
            }

            if (!razaoSocialVar) {
                alert("Por favor, preencha a Razão Social!");
                destacarCampo(input_razao_social);
                return false;
            }
            if (!nomeFantasiaVar) {
                alert("Por favor, preencha o Nome Fantasia!");
                destacarCampo(input_nome_fantasia);
                return false;
            }
            if (!cnpjVar) {
                alert("Por favor, preencha o CNPJ!");
                destacarCampo(input_cnpj);
                return false;
            }


            fetch("/empresas/cadastrar", {

                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    razaoSocial: razaoSocialVar,
                    nomeFantasia: nomeFantasiaVar,
                    cnpj: cnpjVar
                }),
            })
                .then(res => {
                    if (res.ok) {
                        alert('Empresa cadastrada com sucesso!');
                        cadastrarUsuario()
                        window.location.reload();
                    } else {
                        return res.json().then(data => {
                            throw new Error(data.mensagem || "Erro ao cadastrar empresa.");
                        });
                    }
                })

                .catch(erro => {
                    console.error("#ERRO:", erro);
                });

            return false;
        }

//CADASTRANDO USUÁRIO PARA EMPRESA

        function cadastrarUsuario() {
            
            var nomeRepresentante = input_nome_representante.value;
            var emailRepresentante = input_email_representante.value;
            var cpfVar = input_cpf.value;
            var cnpjVar = input_cnpj.value;

            if (!nomeRepresentante || !emailRepresentante || !cpfVar) {
                alert('Preencha todos os campos!');
                return false;
            }

            if (!nomeRepresentante) {
                alert("Por favor, preencha a Razão Social!");
                destacarCampo(input_razao_social);
                return false;
            }
            if (!emailRepresentante) {
                alert("Por favor, preencha o Nome Fantasia!");
                destacarCampo(input_nome_fantasia);
                return false;
            }
            if (!cpfVar) {
                alert("Por favor, preencha o CPF!");
                destacarCampo(input_cnpj);
                return false;
            }

            fetch("/usuario/cadastrar", {

                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nomeRepresentante: nomeRepresentanteVar,
                    emailRepresentante: emailRepresentanteVar,
                    cpf: cpfVar,
                    cnpj: cnpjVar
                }),
            })
                .then(res => {
                    if (res.ok) {
                        alert('Usuario cadastrado com sucesso!');
                        console.log('Chamada para o cadastro realizado com sucesso')
                        window.location.reload();
                    } else {
                        return res.json().then(data => {
                            throw new Error(data.mensagem || "Erro ao cadastrar empresa.");
                        });
                    }
                })

                .catch(erro => {
                    console.error("#ERRO:", erro);
                });

            return false;
        }



        function carregarEmpresasPendentes() {

            console.log("Carregando empresas pendentes...");
            fetch("/leads/pendentes")
                .then(res => res.json())
                .then(empresas => {
                    const tbody = document.querySelector(".solicitacoes tbody");
                    tbody.innerHTML = "";

                    empresas.forEach(empresa => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                <td>${empresa.razao_social}</td>
                <td>${empresa.nome_fantasia}</td>
                <td>${empresa.email}</td>
                <td>${empresa.cnpj}</td>
            `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(erro => {
                    console.error("Erro ao carregar empresas:", erro);
                });
        }

        window.onload = carregarEmpresasPendentes();

    </script>

</body>

</html>